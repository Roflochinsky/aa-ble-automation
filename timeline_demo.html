<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>AA_BLE Timeline Demo — SVG</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { 
  font-family: 'Segoe UI', Arial, sans-serif; 
  background: #f0f2f5; 
  padding: 24px;
  color: #333;
}
.container { max-width: 1400px; margin: 0 auto; }
.card {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  padding: 20px;
  margin-bottom: 20px;
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 20px;
}
.header-left { flex-shrink: 0; }
.title { font-size: 22px; font-weight: 600; color: #1a1a2e; }
.subtitle { font-size: 14px; color: #666; margin-top: 4px; }
.time-display {
  background: #1976d2;
  color: #fff;
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 15px;
  margin-top: 10px;
  display: inline-block;
}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="header">
      <div class="header-left">
        <div class="title">Иванов Иван Иванович</div>
        <div class="subtitle">27-12-2025 • Участок: Монтаж А</div>
        <div class="time-display" id="timeRange">06:00 — 07:00</div>
      </div>
    </div>

    <!-- KPI КАРТОЧКИ -->
    <div class="kpi-section">
      <div class="kpi-cards" id="kpiCards"></div>
    </div>
    
    <!-- ТАЙМЛАЙН -->
    <div class="timeline-wrapper">
      <button class="nav-btn" id="btnLeft" onclick="scrollTimeline(-60)">&lt;</button>
      <div class="viewport" id="viewport">
        <div class="canvas-container" id="canvasContainer">
          <svg id="timelineSvg" height="100"></svg>
        </div>
      </div>
      <button class="nav-btn" id="btnRight" onclick="scrollTimeline(60)">&gt;</button>
    </div>
    
    <div class="time-axis-wrapper">
      <div class="time-axis">
        <div class="time-axis-inner" id="timeAxis"></div>
      </div>
    </div>
    
    <!-- ДЕТАЛИЗАЦИЯ (свёрнута) -->
    <div class="details-section">
      <div class="details-toggle" onclick="toggleDetails()">
        <span class="details-icon" id="detailsIcon">▶</span>
        <span>Детализация по зонам и меткам</span>
      </div>
      <div class="details-content" id="detailsContent" style="display:none;">
        <div id="zonesAccordion"></div>
      </div>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<style>
/* KPI Section */
.kpi-section { margin-bottom: 20px; }
.kpi-cards {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}
.kpi-card {
  flex: 1;
  min-width: 140px;
  padding: 16px;
  border-radius: 10px;
  text-align: center;
  position: relative;
  overflow: hidden;
}
.kpi-card::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 4px;
}
.kpi-card.work { background: #e8f5e9; }
.kpi-card.work::before { background: #27AE60; }
.kpi-card.breaks { background: #ffebee; }
.kpi-card.breaks::before { background: #E74C3C; }
.kpi-card.no-ble { background: #f5f5f5; }
.kpi-card.no-ble::before { background: #95A5A6; }
.kpi-card.other { background: #fff3e0; }
.kpi-card.other::before { background: #E67E22; }
.kpi-card.total { background: #e3f2fd; }
.kpi-card.total::before { background: #1976d2; }
.kpi-label { font-size: 12px; color: #666; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
.kpi-value { font-size: 20px; font-weight: 700; color: #1a1a2e; }
.kpi-pct { font-size: 14px; color: #666; margin-top: 2px; }

/* Timeline */
.timeline-wrapper {
  position: relative;
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 20px;
}
.nav-btn {
  width: 48px;
  height: 100px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 24px;
  font-weight: bold;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  background: #e8f4fd;
  color: #1976d2;
}
.nav-btn:hover { background: #bbdefb; }
.nav-btn:active { transform: scale(0.95); background: #90caf9; }
.nav-btn:disabled { background: #f5f5f5; color: #ccc; cursor: not-allowed; transform: none; }
.viewport {
  flex: 1;
  overflow: hidden;
  border-radius: 8px;
  background: #fafafa;
  border: 1px solid #e0e0e0;
}
.canvas-container { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
.segment { cursor: pointer; transition: filter 0.15s; }
.segment:hover { filter: brightness(1.15) saturate(1.1); }
.time-axis-wrapper { margin-left: 60px; margin-right: 60px; overflow: hidden; }
.time-axis { display: flex; margin-top: 8px; position: relative; height: 24px; }
.time-axis-inner { display: flex; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
.time-label { font-size: 11px; color: #666; text-align: left; flex-shrink: 0; }

/* Details Section */
.details-section {
  margin-top: 20px;
  border-top: 1px solid #eee;
  padding-top: 16px;
}
.details-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  padding: 10px;
  border-radius: 8px;
  font-weight: 500;
  color: #555;
  transition: background 0.2s;
}
.details-toggle:hover { background: #f5f5f5; }
.details-icon { font-size: 12px; transition: transform 0.2s; }
.details-icon.open { transform: rotate(90deg); }
.details-content { margin-top: 12px; }

/* Zone Accordion */
.zone-accordion { margin-bottom: 2px; }
.zone-header {
  display: flex;
  align-items: center;
  padding: 8px 10px;
  cursor: pointer;
  border-radius: 6px;
  transition: background 0.2s;
  font-size: 13px;
}
.zone-header:hover { background: #f5f5f5; }
.zone-toggle { font-size: 10px; margin-right: 8px; color: #666; transition: transform 0.2s; width: 12px; }
.zone-toggle.open { transform: rotate(90deg); }
.zone-dot { width: 12px; height: 12px; border-radius: 4px; margin-right: 10px; flex-shrink: 0; }
.zone-name { flex: 1; color: #333; }
.zone-value { font-weight: 600; color: #333; margin-left: 8px; white-space: nowrap; }
.zone-content { margin-left: 30px; padding-left: 10px; border-left: 2px solid #e0e0e0; display: none; }
.tag-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 10px;
  margin: 3px 0;
  border-radius: 6px;
  font-size: 12px;
}
.tag-name { flex: 1; color: #555; }
.tag-value { font-weight: 600; color: #333; margin-left: 8px; }

/* Tooltip */
.tooltip {
  position: fixed;
  background: #1a1a2e;
  color: #fff;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 13px;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
  z-index: 1000;
  max-width: 280px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.25);
}
.tooltip.visible { opacity: 1; }
.tooltip-row { margin: 4px 0; display: flex; justify-content: space-between; gap: 16px; }
.tooltip-label { color: #aaa; }
.tooltip-value { font-weight: 600; }
.tooltip-header { 
  font-weight: 600; 
  font-size: 14px; 
  margin-bottom: 8px; 
  padding-bottom: 8px; 
  border-bottom: 1px solid #333;
}
</style>

<script>
// ============ КОНФИГУРАЦИЯ ============
const CONFIG = {
  MINUTE_WIDTH: 20,
  SEGMENT_HEIGHT: 100,
  VIEWPORT_MINUTES: 720,
  SCROLL_STEP: 60,
  WINDOW_START: 6 * 60,
  WINDOW_END: 23 * 60,
};
const TOTAL_MINUTES = CONFIG.WINDOW_END - CONFIG.WINDOW_START;

const ZONE_COLORS = {
  0: '#95A5A6', 1: '#27AE60', 2: '#E67E22', 4: '#E74C3C',
  5: '#8E44AD', 7: '#F1C40F', 10: '#1F77B4', 13: '#E67E22',
};
const ZONE_NAMES = {
  0: 'Вне зоны BLE-маячков', 1: 'Зоны проведения работ', 2: 'Столовые',
  4: 'Курилки', 5: 'Зоны отдыха', 7: 'Туалеты', 10: 'Зона выдачи WW', 13: 'КПП',
};
const ZONE_ORDER = [1, 4, 10, 13, 2, 7, 0, 5];

// KPI группировка зон
const KPI_GROUPS = {
  work: [1],           // В работе
  breaks: [2, 4, 5, 7], // Перерывы (столовые, курилки, отдых, туалеты)
  no_ble: [0],         // Вне BLE
  other: [10, 13, 3, 6, 8, 9, 11, 12] // Прочее
};

// ============ ДЕМО-ДАННЫЕ ============
function generateDemoData() {
  const segments = [];
  let currentZone = 1;
  let currentTag = 42;
  
  for (let m = 0; m < TOTAL_MINUTES; m++) {
    if (Math.random() < 0.02) {
      const zones = [0, 1, 1, 1, 1, 2, 4, 7, 10, 13];
      currentZone = zones[Math.floor(Math.random() * zones.length)];
      currentTag = Math.floor(Math.random() * 100) + 1;
    }
    if (Math.random() < 0.01) continue;
    
    segments.push({
      minute: m,
      zone: currentZone,
      tag: currentTag,
      desc: `Участок ${String.fromCharCode(65 + (currentTag % 10))}`,
    });
  }
  return segments;
}

const DATA = generateDemoData();
let offset = 0;

// ============ УТИЛИТЫ ============
function lightenColor(hex, factor = 0.4) {
  hex = hex.replace('#', '');
  const r = parseInt(hex.substr(0, 2), 16);
  const g = parseInt(hex.substr(2, 2), 16);
  const b = parseInt(hex.substr(4, 2), 16);
  const nr = Math.round(r + (255 - r) * factor);
  const ng = Math.round(g + (255 - g) * factor);
  const nb = Math.round(b + (255 - b) * factor);
  return `#${nr.toString(16).padStart(2,'0')}${ng.toString(16).padStart(2,'0')}${nb.toString(16).padStart(2,'0')}`;
}

function formatTime(m) {
  const h = Math.floor(m / 60);
  const mm = m % 60;
  return `${h.toString().padStart(2, '0')}:${mm.toString().padStart(2, '0')}`;
}

function formatDuration(mins) {
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  if (h === 0) return `${m} мин`;
  return `${h}ч ${m.toString().padStart(2, '0')}м`;
}

// ============ РАСЧЁТ KPI ============
function calculateKPI() {
  const total = DATA.length;
  const byGroup = { work: 0, breaks: 0, no_ble: 0, other: 0 };
  
  DATA.forEach(seg => {
    if (KPI_GROUPS.work.includes(seg.zone)) byGroup.work++;
    else if (KPI_GROUPS.breaks.includes(seg.zone)) byGroup.breaks++;
    else if (KPI_GROUPS.no_ble.includes(seg.zone)) byGroup.no_ble++;
    else byGroup.other++;
  });
  
  return {
    work: { minutes: byGroup.work, pct: total > 0 ? Math.round(byGroup.work / total * 100) : 0 },
    breaks: { minutes: byGroup.breaks, pct: total > 0 ? Math.round(byGroup.breaks / total * 100) : 0 },
    no_ble: { minutes: byGroup.no_ble, pct: total > 0 ? Math.round(byGroup.no_ble / total * 100) : 0 },
    other: { minutes: byGroup.other, pct: total > 0 ? Math.round(byGroup.other / total * 100) : 0 },
    total: { minutes: total }
  };
}

function calculateStats() {
  const zoneStats = {};
  DATA.forEach(seg => {
    if (!zoneStats[seg.zone]) zoneStats[seg.zone] = { minutes: 0, tags: {} };
    zoneStats[seg.zone].minutes++;
    if (!zoneStats[seg.zone].tags[seg.tag]) {
      zoneStats[seg.zone].tags[seg.tag] = { minutes: 0, desc: seg.desc };
    }
    zoneStats[seg.zone].tags[seg.tag].minutes++;
  });
  return { zoneStats, totalPresence: DATA.length };
}

// ============ РЕНДЕР KPI ============
function renderKPI() {
  const kpi = calculateKPI();
  const container = document.getElementById('kpiCards');
  
  container.innerHTML = `
    <div class="kpi-card work">
      <div class="kpi-label">Зоны проведения работ</div>
      <div class="kpi-value">${formatDuration(kpi.work.minutes)}</div>
      <div class="kpi-pct">${kpi.work.pct}%</div>
    </div>
    <div class="kpi-card breaks">
      <div class="kpi-label">Зоны перерывов</div>
      <div class="kpi-value">${formatDuration(kpi.breaks.minutes)}</div>
      <div class="kpi-pct">${kpi.breaks.pct}%</div>
    </div>
    <div class="kpi-card no-ble">
      <div class="kpi-label">Вне BLE</div>
      <div class="kpi-value">${formatDuration(kpi.no_ble.minutes)}</div>
      <div class="kpi-pct">${kpi.no_ble.pct}%</div>
    </div>
    <div class="kpi-card other">
      <div class="kpi-label">Прочее</div>
      <div class="kpi-value">${formatDuration(kpi.other.minutes)}</div>
      <div class="kpi-pct">${kpi.other.pct}%</div>
    </div>
    <div class="kpi-card total">
      <div class="kpi-label">Итого</div>
      <div class="kpi-value">${formatDuration(kpi.total.minutes)}</div>
      <div class="kpi-pct">100%</div>
    </div>
  `;
}

// ============ РЕНДЕР ТАЙМЛАЙН ============
function render() {
  renderKPI();
  
  const svg = document.getElementById('timelineSvg');
  const totalWidth = TOTAL_MINUTES * CONFIG.MINUTE_WIDTH;
  svg.setAttribute('width', totalWidth);
  svg.innerHTML = '';
  
  DATA.forEach(seg => {
    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute('x', seg.minute * CONFIG.MINUTE_WIDTH);
    rect.setAttribute('y', 0);
    rect.setAttribute('width', CONFIG.MINUTE_WIDTH - 1);
    rect.setAttribute('height', CONFIG.SEGMENT_HEIGHT);
    rect.setAttribute('fill', ZONE_COLORS[seg.zone] || '#95A5A6');
    rect.setAttribute('rx', 3);
    rect.setAttribute('class', 'segment');
    rect.dataset.minute = seg.minute;
    rect.dataset.zone = seg.zone;
    rect.dataset.tag = seg.tag;
    rect.dataset.desc = seg.desc;
    
    rect.addEventListener('mouseenter', showTooltip);
    rect.addEventListener('mouseleave', hideTooltip);
    rect.addEventListener('mousemove', moveTooltip);
    
    svg.appendChild(rect);
  });
  
  renderTimeAxis();
  renderZonesPanel();
  updateOffset();
}

function renderTimeAxis() {
  const axis = document.getElementById('timeAxis');
  axis.innerHTML = '';
  for (let m = 0; m <= TOTAL_MINUTES; m += 15) {
    const label = document.createElement('div');
    label.className = 'time-label';
    label.style.width = (15 * CONFIG.MINUTE_WIDTH) + 'px';
    label.textContent = formatTime(CONFIG.WINDOW_START + m);
    axis.appendChild(label);
  }
}

// ============ РЕНДЕР ДЕТАЛИЗАЦИИ ============
function renderZonesPanel() {
  const container = document.getElementById('zonesAccordion');
  const { zoneStats, totalPresence } = calculateStats();
  
  let html = '';
  const sortedZones = Object.keys(zoneStats)
    .map(Number)
    .sort((a, b) => {
      const ia = ZONE_ORDER.indexOf(a);
      const ib = ZONE_ORDER.indexOf(b);
      return (ia === -1 ? 999 : ia) - (ib === -1 ? 999 : ib);
    });
  
  sortedZones.forEach(zoneId => {
    const zone = zoneStats[zoneId];
    const zonePct = totalPresence > 0 ? ((zone.minutes / totalPresence) * 100).toFixed(1) : 0;
    const color = ZONE_COLORS[zoneId] || '#95A5A6';
    const lightColor = lightenColor(color, 0.4);
    const zoneName = ZONE_NAMES[zoneId] || `Зона ${zoneId}`;
    
    const sortedTags = Object.entries(zone.tags).sort((a, b) => b[1].minutes - a[1].minutes);
    
    let tagsHtml = '';
    sortedTags.forEach(([tagId, tagData]) => {
      const tagPct = totalPresence > 0 ? ((tagData.minutes / totalPresence) * 100).toFixed(1) : 0;
      const tagLabel = tagData.desc ? `#${tagId} (${tagData.desc})` : `#${tagId}`;
      tagsHtml += `
        <div class="tag-row" style="background: ${lightColor}">
          <span class="tag-name">${tagLabel}</span>
          <span class="tag-value">${formatDuration(tagData.minutes)} (${tagPct}%)</span>
        </div>
      `;
    });
    
    html += `
      <div class="zone-accordion">
        <div class="zone-header" onclick="toggleZone(this)">
          <span class="zone-toggle">▶</span>
          <div class="zone-dot" style="background: ${color}"></div>
          <span class="zone-name">${zoneName}</span>
          <span class="zone-value">${formatDuration(zone.minutes)} (${zonePct}%)</span>
        </div>
        <div class="zone-content">${tagsHtml}</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// ============ НАВИГАЦИЯ ============
function scrollTimeline(minutes) {
  offset = Math.max(0, Math.min(offset + minutes, TOTAL_MINUTES - CONFIG.VIEWPORT_MINUTES));
  updateOffset();
}

function updateOffset() {
  const px = offset * CONFIG.MINUTE_WIDTH;
  document.getElementById('canvasContainer').style.transform = `translateX(-${px}px)`;
  document.getElementById('timeAxis').style.transform = `translateX(-${px}px)`;
  
  document.getElementById('btnLeft').disabled = (offset <= 0);
  document.getElementById('btnRight').disabled = (offset >= TOTAL_MINUTES - CONFIG.VIEWPORT_MINUTES);
  
  const startMins = CONFIG.WINDOW_START + offset;
  const endMins = startMins + 60;
  document.getElementById('timeRange').textContent = `${formatTime(startMins)} — ${formatTime(endMins)}`;
}

// ============ TOGGLE ============
function toggleDetails() {
  const content = document.getElementById('detailsContent');
  const icon = document.getElementById('detailsIcon');
  if (content.style.display === 'none') {
    content.style.display = 'block';
    icon.classList.add('open');
  } else {
    content.style.display = 'none';
    icon.classList.remove('open');
  }
}

function toggleZone(header) {
  const content = header.nextElementSibling;
  const toggle = header.querySelector('.zone-toggle');
  if (content.style.display === 'none' || content.style.display === '') {
    content.style.display = 'block';
    toggle.classList.add('open');
  } else {
    content.style.display = 'none';
    toggle.classList.remove('open');
  }
}

// ============ TOOLTIP ============
function showTooltip(e) {
  const tooltip = document.getElementById('tooltip');
  const rect = e.target;
  
  const minute = parseInt(rect.dataset.minute);
  const timeStr = formatTime(CONFIG.WINDOW_START + minute);
  const zone = parseInt(rect.dataset.zone);
  const tag = rect.dataset.tag;
  const desc = rect.dataset.desc;
  
  tooltip.innerHTML = `
    <div class="tooltip-header">${timeStr}</div>
    <div class="tooltip-row">
      <span class="tooltip-label">Зона:</span>
      <span class="tooltip-value">${ZONE_NAMES[zone] || 'Зона ' + zone}</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Метка:</span>
      <span class="tooltip-value">#${tag}</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Описание:</span>
      <span class="tooltip-value">${desc}</span>
    </div>
  `;
  
  tooltip.classList.add('visible');
  moveTooltip(e);
}

function moveTooltip(e) {
  const tooltip = document.getElementById('tooltip');
  tooltip.style.left = (e.clientX + 15) + 'px';
  tooltip.style.top = (e.clientY + 15) + 'px';
}

function hideTooltip() {
  document.getElementById('tooltip').classList.remove('visible');
}

// ============ INIT ============
document.addEventListener('DOMContentLoaded', render);

document.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowLeft') scrollTimeline(-CONFIG.SCROLL_STEP);
  if (e.key === 'ArrowRight') scrollTimeline(CONFIG.SCROLL_STEP);
});
</script>
</body>
</html>
